(function(){function j(){var b={data:{orgs:h,students:{}}};jQuery.each(g,function(c,a){if(a.proposals.length<2)return true;b.data.students[c]=a;i.showDuplicatesHtml(h,a,c,a.proposals)});html_string===""&&jQuery("#div_duplicate_slots").html("<strong>No duplicate slots found</strong>");jQuery.ajax({url:location.href,type:"POST",processData:true,data:{result:JSON.stringify(b)},contentType:"application/json",dataType:"json"})}function k(b){if(b){jQuery.each(b.data.orgs,function(c,a){h[c]=a});jQuery(b.data.proposals).each(function(c,
a){if(g[a.student_key]===undefined){g[a.student_key]={};g[a.student_key].name=a.student_name;g[a.student_key].contact=a.student_contact;g[a.student_key].proposals=[]}g[a.student_key].proposals.push({org_key:a.org_key,proposal_key:a.key_name,proposal_title:a.proposal_title})})}}function l(b,c,a){var d=0;h={};g=[];setTimeout(function(){jQuery.ajax({cache:false,mode:"sync",type:"GET",timeout:1E6,dataType:"json",url:["/program/assigned_proposals/",b,"?limit=",c,"&offset=",d].join(""),success:function(e){e&&
k(e)},error:function(e){e!==undefined&&jQuery("#id_button_duplicate_slots").fadeIn("slow",function(){jQuery("#description_done").html("<strong class='error'> Error encountered, try again</strong>")})}});d+=c;d<a&&setTimeout(arguments.callee,1)},1);return false}var i=window.duplicateSlots=function(){},h={},g=[];i.showDuplicatesHtml=function(b,c,a,d){if(html_string===""){jQuery("#div_duplicate_slots").html("");html_string="<ul>"}html_string+=['<li>  Student:     <strong>      <a href="/student/show/',
a,'">',c.name,'</a>    </strong> (<a href="mailto:',c.contact,'">',c.contact,"</a>)"].join("");html_string+="<ul>";jQuery(d).each(function(e,f){html_string+=['<li>  Organization:     <a href="/org/show/',f.org_key,'">',b[f.org_key].name,"</a>, admin: ",b[f.org_key].admin_name,' (<a href="mailto:',b[f.org_key].admin_email,'">',b[f.org_key].admin_email,"</a>)</li>"].join("");html_string+=['<ul>  <li>Proposal: <a href="/student_proposal/show/',f.proposal_key,'">',f.proposal_title,"</a>  </li></ul>"].join("")});
html_string+="</ul></li>";html_string+="</ul>";jQuery("#div_duplicate_slots").html(html_string)};i.showDuplicatesInit=function(){html_string="";var b=this,c=number_of_orgs,a=offset_length,d=number_of_orgs%offset_length===0?Math.floor(number_of_orgs/offset_length):Math.floor(number_of_orgs/offset_length)+1;if(d===0)jQuery("#div_duplicate_slots").html("<strong>No org slots to process</strong>");else{var e=0;jQuery("#id_button_duplicate_slots").fadeOut("slow",function(){jQuery("#duplicates_progress_bar").progressBar(0);
jQuery("#description_done").html("");jQuery(this).bind("ajaxSuccess",function(){e++;var f=Math.floor(100*e/d);jQuery("#duplicates_progress_bar").progressBar(f);jQuery("#description_progressbar").html([" Processed orgs chunk ",e,"/",d].join(""));if(e===d){jQuery("#applications_progress_bar").fadeOut("slow",function(){jQuery("#duplicates_progress_bar").progressBar(0);jQuery("#id_button_duplicate_slots").fadeIn("slow")});jQuery("#description_progressbar").html("");jQuery("#description_done").html("<strong> Done!</strong>");
jQuery("#duplicates_progress_bar").fadeOut("slow",function(){jQuery("#id_button_duplicate_slots").val("Recalculate").fadeIn("slow",function(){j.call(b)})})}});jQuery("#duplicates_progress_bar").fadeIn("slow",l.apply(b,[url_to_query,a,c]))})}}})();
